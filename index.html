<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>גאלה 2025 | Gala 2025 - רישום</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      direction: rtl;
    }
    .container {
      max-width: 900px;
      margin: 30px auto;
      background: #ffffff;
      padding: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border-radius: 8px;
    }
    .logo {
      text-align: center;
      margin-bottom: 15px;
    }
    .logo img {
      max-width: 250px;
      height: auto;
    }
    h1 {
      text-align: center;
      margin: 5px 0 20px 0;
      line-height: 1.4;
    }
    h2 {
      margin-top: 25px;
      border-bottom: 1px solid #ddd;
      padding-bottom: 4px;
      font-size: 1.1rem;
    }
    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
      font-size: 0.95rem;
    }
    input, select {
      width: 100%;
      padding: 8px;
      margin-top: 4px;
      box-sizing: border-box;
      font-size: 0.95rem;
    }
    .participants {
      margin-top: 15px;
    }
    .participant-card {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 10px;
      background: #fafafa;
    }
    .participant-title {
      font-weight: bold;
      margin-bottom: 10px;
    }
    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    .row > div {
      flex: 1;
      min-width: 180px;
    }
    .actions {
      margin-top: 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
      font-size: 0.95rem;
    }
    .btn-add {
      background: #e0e0e0;
    }
    .btn-submit {
      background: #b31b1b;
      color: #fff;
    }
    .note {
      font-size: 0.9em;
      color: #555;
      margin-top: 8px;
    }
    .total-amount {
      font-weight: bold;
      font-size: 1rem;
      margin-top: 10px;
    }
    .policy {
      margin-top: 25px;
      font-size: 0.9rem;
      border-top: 1px solid #ddd;
      padding-top: 10px;
      color: #444;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- לוגו -->
    <div class="logo">
      <!-- כשאתה מעלה ל-GitHub, דאג שהקובץ יהיה באותה תיקייה בשם הזה -->
      <img src="New Gala Logo 2022.png" alt="Gala 2025 Logo" />
    </div>

    <!-- כותרת בעברית ואנגלית -->
    <h1>
      גאלה 2025<br />
      <span style="font-size: 0.9em;">Gala 2025</span>
    </h1>

    <form id="registrationForm">
      <!-- פרטי המזמין -->
      <h2>פרטי המזמין / Registrant Details</h2>

      <label>
        שם פרטי / First Name
        <input type="text" name="primary_first_name" required />
      </label>

      <label>
        שם משפחה / Last Name
        <input type="text" name="primary_last_name" required />
      </label>

      <label>
        דוא"ל / Email
        <input type="email" name="primary_email" required />
      </label>

      <label>
        טלפון / Phone
        <input type="tel" name="primary_phone" />
      </label>

      <label>
        כמות כרטיסים / Number of Tickets
        <input type="number" id="ticketCount" name="ticket_count" min="1" value="1" required />
      </label>

      <p class="note">
        אם אתה נרשם לבד, הפרטים שלך ישמשו כפרטי המשתתף. אם אתה רושם משתתפים נוספים,
        מלא בבקשה את הפרטים עבור כל אחד.
        <br />
        If you register only for yourself, your details will be used as the participant's details.
        If you register additional guests, please fill in details for each.
      </p>

      <!-- משתתף ראשון = המזמין -->
      <div class="participants">
        <div class="participant-card">
          <div class="participant-title">
            משתתף 1 (המזמין) / Participant 1 (Registrant)
          </div>

          <p class="note">
            שם המשתתף יהיה כמו שם המזמין. כאן יש לבחור אוניברסיטה וסוג משתתף.
            <br />
            Participant name will be the same as the registrant's name. Please choose university and participant type.
          </p>

          <label>
            אוניברסיטה / University
            <input type="text" id="primary_participant_university" name="primary_participant_university" required />
          </label>

          <div class="row">
            <div>
              <label>
                סוג משתתף / Participant Type
                <select id="primary_participant_type" name="primary_participant_type" required>
                  <option value="">בחר / Select</option>
                  <option value="student">
                    סטודנט / בוגר טרי (מחזור 2023 ומעלה) / Student or Class of 2023+
                  </option>
                  <option value="veteran">
                    בוגר ותיק / Senior Alum
                  </option>
                </select>
              </label>
            </div>
            <div>
              <label>
                תעריף (₪) / Rate (NIS)
                <input type="number" id="primary_participant_rate" name="primary_participant_rate" readonly />
              </label>
            </div>
          </div>
        </div>

        <!-- משתתפים נוספים -->
        <div id="extraParticipantsContainer"></div>
      </div>

      <div class="actions">
        <button type="button" class="btn btn-add" id="addParticipantBtn">
          הוסף משתתף נוסף / Add Participant
        </button>

        <div class="total-amount" id="totalAmount">
          סה״כ לתשלום (משוער): 0 ₪
          <br />
          Estimated total: 0 NIS
        </div>

        <button type="button" class="btn btn-submit" id="submitBtn">
          שליחת רישום (ללא תשלום) / Submit Registration (No Payment Yet)
        </button>
      </div>

      <p class="note">
        בשלב זה זהו ניסוי רישום בלבד, ללא חיבור לתשלום.
        <br />
        This is currently a registration test only, without payment.
      </p>

      <!-- דמי ביטול -->
      <div class="policy">
        <strong>דמי ביטול:</strong><br />
        ביטול עד 72 שעות לפני האירוע – יחויב ב-6% דמי ביטול.
        ביטול בתוך 72 שעות לפני האירוע – לא יהיו החזרים.
        <br /><br />
        <strong>Cancellation Policy:</strong><br />
        Cancellations made up to 72 hours before the event will be charged a 6% cancellation fee.
        Cancellations within 72 hours before the event are non-refundable.
      </div>
    </form>
  </div>

  <script>
    // ***** כאן אתה מדביק את ה-URL מה-Apps Script שלך *****
    const SCRIPT_URL = "PASTE_YOUR_SCRIPT_WEB_APP_URL_HERE";

    const ticketCountInput = document.getElementById("ticketCount");
    const extraContainer = document.getElementById("extraParticipantsContainer");
    const addParticipantBtn = document.getElementById("addParticipantBtn");
    const primaryTypeSelect = document.getElementById("primary_participant_type");
    const primaryRateInput = document.getElementById("primary_participant_rate");
    const totalAmountEl = document.getElementById("totalAmount");
    const submitBtn = document.getElementById("submitBtn");
    const form = document.getElementById("registrationForm");

    function getRateForType(type) {
      if (type === "student") return 300;
      if (type === "veteran") return 360;
      return 0;
    }

    function updatePrimaryRate() {
      const type = primaryTypeSelect.value;
      const rate = getRateForType(type);
      primaryRateInput.value = rate || "";
      recalcTotal();
    }

    function createExtraParticipantCard(index) {
      const div = document.createElement("div");
      div.className = "participant-card extra-participant";
      div.dataset.index = index;

      div.innerHTML = `
        <div class="participant-title">
          משתתף ${index} / Participant ${index}
        </div>
        <div class="row">
          <div>
            <label>
              שם פרטי / First Name
              <input type="text" name="participant_${index}_first_name" required />
            </label>
          </div>
          <div>
            <label>
              שם משפחה / Last Name
              <input type="text" name="participant_${index}_last_name" required />
            </label>
          </div>
        </div>
        <label>
          אוניברסיטה / University
          <input type="text" name="participant_${index}_university" required />
        </label>
        <div class="row">
          <div>
            <label>
              סוג משתתף / Participant Type
              <select class="participant-type" name="participant_${index}_type" required>
                <option value="">בחר / Select</option>
                <option value="student">
                  סטודנט / בוגר טרי (מחזור 2023 ומעלה) / Student or Class of 2023+
                </option>
                <option value="veteran">
                  בוגר ותיק / Senior Alum
                </option>
              </select>
            </label>
          </div>
          <div>
            <label>
              תעריף (₪) / Rate (NIS)
              <input type="number" class="participant-rate" name="participant_${index}_rate" readonly />
            </label>
          </div>
        </div>
      `;

      // לחיבור התעריף האוטומטי
      const typeSelect = div.querySelector(".participant-type");
      const rateInput = div.querySelector(".participant-rate");

      typeSelect.addEventListener("change", function () {
        const rate = getRateForType(typeSelect.value);
        rateInput.value = rate || "";
        recalcTotal();
      });

      return div;
    }

    function syncExtraParticipants() {
      let ticketCount = parseInt(ticketCountInput.value, 10);
      if (isNaN(ticketCount) || ticketCount < 1) ticketCount = 1;
      ticketCountInput.value = ticketCount;

      // מספר המשתתפים הנוספים = סה"כ כרטיסים פחות 1 (המזמין)
      const desiredExtras = Math.max(ticketCount - 1, 0);

      // בניה מחדש כדי להימנע מבעיות אינדקס
      extraContainer.innerHTML = "";
      for (let index = 2; index <= ticketCount; index++) {
        extraContainer.appendChild(createExtraParticipantCard(index));
      }

      recalcTotal();
    }

    function recalcTotal() {
      let total = 0;

      // משתתף ראשון
      const primaryType = primaryTypeSelect.value;
      total += getRateForType(primaryType);

      // משתתפים נוספים
      document.querySelectorAll(".extra-participant").forEach((card) => {
        const typeSelect = card.querySelector(".participant-type");
        if (!typeSelect) return;
        const type = typeSelect.value;
        total += getRateForType(type);
      });

      totalAmountEl.innerHTML =
        'סה״כ לתשלום (משוער): ' + total + ' ₪' +
        '<br />Estimated total: ' + total + ' NIS';
    }

    ticketCountInput.addEventListener("change", syncExtraParticipants);
    addParticipantBtn.addEventListener("click", () => {
      let current = parseInt(ticketCountInput.value, 10) || 1;
      ticketCountInput.value = current + 1;
      syncExtraParticipants();
    });
    primaryTypeSelect.addEventListener("change", updatePrimaryRate);

    async function submitRegistrationToSheet(payload) {
      if (!SCRIPT_URL || SCRIPT_URL === "PASTE_YOUR_SCRIPT_WEB_APP_URL_HERE") {
        alert("לא הוגדר SCRIPT_URL. נא להדביק את כתובת ה-Web App של Google Apps Script בקוד.");
        return;
      }

      try {
        await fetch(SCRIPT_URL, {
          method: "POST",
          mode: "no-cors", // כדי לעקוף CORS – לא נקרא תגובה
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });
      } catch (err) {
        console.error("Error sending to Google Script:", err);
      }
    }

    async function handleSubmit() {
      // בדיקת ולידציה בסיסית של ה-HTML
      if (!form.checkValidity()) {
        // גורם לדפדפן להציג הודעות שגיאה רגילות
        form.reportValidity();
        return;
      }

      const buyerFirst = document.querySelector('[name="primary_first_name"]').value.trim();
      const buyerLast = document.querySelector('[name="primary_last_name"]').value.trim();
      const buyerEmail = document.querySelector('[name="primary_email"]').value.trim();
      const buyerPhone = document.querySelector('[name="primary_phone"]').value.trim();

      const primaryUniversity = document.getElementById("primary_participant_university").value.trim();
      const primaryType = primaryTypeSelect.value;
      const primaryRate = getRateForType(primaryType);

      const ticketCount = parseInt(ticketCountInput.value, 10) || 1;

      const participants = [];

      // משתתף 1 = המזמין
      participants.push({
        first_name: buyerFirst,
        last_name: buyerLast,
        university: primaryUniversity,
        type: primaryType,
        rate: primaryRate,
      });

      // משתתפים נוספים
      document.querySelectorAll(".extra-participant").forEach((card) => {
        const idx = card.dataset.index;
        const firstName = card.querySelector(`[name="participant_${idx}_first_name"]`).value.trim();
        const lastName = card.querySelector(`[name="participant_${idx}_last_name"]`).value.trim();
        const university = card.querySelector(`[name="participant_${idx}_university"]`).value.trim();
        const type = card.querySelector(`[name="participant_${idx}_type"]`).value;
        const rate = getRateForType(type);

        participants.push({
          first_name: firstName,
          last_name: lastName,
          university: university,
          type: type,
          rate: rate,
        });
      });

      // לוודא שמספר המשתתפים מתאים לכמות הכרטיסים
      if (participants.length !== ticketCount) {
        alert("מספר המשתתפים לא תואם את כמות הכרטיסים. אנא בדוק שוב.");
        return;
      }

      const payload = {
        buyer: {
          first_name: buyerFirst,
          last_name: buyerLast,
          email: buyerEmail,
          phone: buyerPhone,
        },
        participants: participants,
      };

      // שליחה ל-Google Sheet + מייל
      await submitRegistrationToSheet(payload);

      alert("הרישום נשלח לגיליון Google Sheets. בדוק את הגיליון ואת המייל שלך.\nRegistration submitted to Google Sheets. Please check your sheet and email.");

      // אם תרצה בעתיד להפנות לתשלום, אפשר כאן:
      // window.location.href = "https://your-payment-link.com";
    }

    submitBtn.addEventListener("click", handleSubmit);

    // הפעלה ראשונית
    syncExtraParticipants();
    updatePrimaryRate();
  </script>
</body>
</html>
